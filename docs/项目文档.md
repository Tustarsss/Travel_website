# 个性化旅游系统项目文档  
**版本：1.0**  
**目标受众：AI开发系统（用于自动化代码生成与实现）**  
**文档目的：** 本项目文档为AI开发提供完整、结构化、无歧义的指令集，涵盖系统功能、数据要求、算法规范及验收标准。所有需求均基于用户原始描述，已转化为可执行开发任务。AI必须严格遵循文档中的技术规范和约束条件，确保输出可直接用于系统构建。

---

## 1. 项目概述  
开发一个**个性化旅游系统**，帮助用户管理旅游活动全周期（旅游前、旅游中、旅游后）。系统核心功能包括：  
- **旅游前**：基于热度、评价及用户兴趣的景点/学校推荐与查询。  
- **旅游中**：景区/校园内部的最优路线规划（支持单点、多点、多交通工具策略）及场所查询。  
- **旅游后**：旅游日记生成、管理、交流与AIGC动画生成。  
**关键约束**：  
- 数据规模必须满足最低要求（景区/校园≥200个，道路边≥200条等）。  
- 核心算法必须高效处理动态数据（如部分排序、快速查找）。  
- 所有功能需通过图形界面交互，地图展示为必需组件。  

### 1.1 技术栈概览  
- **前端**：Vue 3 + Vite + TypeScript + Pinia + Axios；地图组件采用 Leaflet（可替换为 MapLibre），样式使用 Tailwind CSS。  
- **后端**：Python 3.11 + FastAPI + Uvicorn；ORM 使用 SQLModel（SQLAlchemy 2.0 内核），Pydantic 作为数据验证层。  
- **数据库**：SQLite（开发/测试环境默认），保留 PostgreSQL 适配层；全文检索与空间索引结果持久化到 SQLite/JSON 混合存储。  
- **任务调度**：APScheduler 定时任务 + FastAPI BackgroundTasks；如需扩展，预留 Celery（Redis broker）集成。  
- **测试与构建**：Pytest + Coverage、Ruff、Mypy、Vitest、Cypress、ESLint、Prettier；CI 建议采用 GitHub Actions。  
- **多媒体/AI**：MoviePy + FFmpeg 生成动画，外部 AIGC/本地模型均通过统一接口调用。  

### 1.2 系统架构分层  
| 层级 | 关键职责 | 实现要点 |  
|------|----------|----------|  
| 前端展示层 | 用户交互、地图展示、富文本编辑、媒体上传、动画播放 | Vue 组件化、Leaflet 地图封装、Pinia 全局状态、Axios 请求封装 |  
| API 接口层 | HTTP/JSON API、参数校验、响应封装、鉴权预留 | FastAPI 路由拆分为 `recommendation`、`routing`、`facility`、`diary`、`aigc` 等模块 |  
| 服务/领域层 | 业务编排、规则引擎、缓存刷新 | 独立 service 类组合算法与仓储，集中处理热度刷新、拥挤度策略、兴趣权重等规则 |  
| 算法层 | 核心算法实现（部分排序、Dijkstra、TSP、R 树、倒排索引、压缩） | 模块化封装，提供统一接口与基准测试，面向服务层调用 |  
| 数据访问层 | ORM 模型、仓储封装、事务管理 | SQLModel 定义实体，仓储层提供 CRUD、批量导入、分页查询，支持 SQLite/PostgreSQL 切换 |  
| 数据与存储 | 结构化数据、媒体文件、索引文件 | SQLite 数据库、`storage/` 媒体目录、`indexes/` 存放空间索引与倒排索引文件 |  
| 后台任务层 | 热度/拥挤度定时更新、动画生成队列、数据验证脚本 | APScheduler、BackgroundTasks 结合；必要时引入专用 worker 处理 AIGC 任务 |  

### 1.3 模块划分与目录建议  
```
Travel_website/
├── backend/
│   ├── app/
│   │   ├── main.py
│   │   ├── api/
│   │   │   ├── v1/
│   │   │   │   ├── recommendation.py
│   │   │   │   ├── routing.py
│   │   │   │   ├── facility.py
│   │   │   │   ├── diary.py
│   │   │   │   └── aigc.py
│   │   ├── services/
│   │   ├── algorithms/
│   │   ├── repositories/
│   │   ├── schemas/
│   │   ├── models/
│   │   ├── background/
│   │   └── core/
│   ├── tests/
│   │   ├── algorithms/
│   │   ├── services/
│   │   └── api/
│   ├── scripts/
│   │   ├── generate_data.py
│   │   ├── validate_data.py
│   │   ├── load_test.py
│   │   └── seed_demo.py
│   └── pyproject.toml
├── frontend/
│   ├── src/
│   │   ├── pages/
│   │   ├── components/
│   │   ├── stores/
│   │   ├── services/
│   │   ├── router/
│   │   └── assets/
│   ├── public/
│   ├── tests/
│   └── package.json
├── storage/
├── indexes/
└── docs/
```

---

## 2. 数据要求  
AI必须生成或集成以下数据集，**数据规模为硬性要求**。数据需存储于结构化数据库（如SQLite/PostgreSQL），格式为JSON/CSV。若真实数据不足，需用模拟数据填充（模拟逻辑见附录A）。  

### 2.1 数据集定义  
| **数据类型**       | **要求**                                                                 | **数据结构示例（JSON Schema）**                                                                 |  
|--------------------|--------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------|  
| **景区/校园**      | - 总数 ≥ 200（景区与校园比例自定，但需明确区分类型）<br>- 每个景区/校园ID、名称、类型（景区/校园）、热度值（0-100）、平均评价（0-5星） | ```json<br>{<br>  "id": "scenic_001",<br>  "name": "西湖景区",<br>  "type": "scenic",<br>  "popularity": 95,<br>  "rating": 4.7<br>}``` |  
| **建筑物**         | - 每个景区/校园内建筑物 ≥ 20个<br>- 类型：景点、教学楼、办公楼、宿舍楼等<br>- 属性：ID、名称、类别、坐标（经度,纬度） | ```json<br>{<br>  "id": "bld_001",<br>  "name": "雷峰塔",<br>  "category": "scenic_spot",<br>  "coordinates": [120.155, 30.243]<br>}``` |  
| **服务设施**       | - 总数 ≥ 50个，覆盖 ≥ 10种类型（商店、饭店、洗手间、图书馆、食堂、超市、咖啡馆、ATM、医疗点、停车场）<br>- 属性：ID、名称、类别、坐标、所属景区/校园ID | ```json<br>{<br>  "id": "fac_001",<br>  "name": "景区洗手间A",<br>  "category": "restroom",<br>  "coordinates": [120.156, 30.244],<br>  "parent_id": "scenic_001"<br>}``` |  
| **道路网络**       | - 总边数 ≥ 200条<br>- 每条边表示两点间路径（建筑物/设施间）<br>- 属性：起点ID、终点ID、距离（米）、理想速度（米/秒）、拥挤度（0.1-1.0）、交通工具类型（步行/自行车/电瓶车） | ```json<br>{<br>  "start_id": "bld_001",<br>  "end_id": "fac_001",<br>  "distance": 150,<br>  "ideal_speed": 1.4, // 步行速度<br>  "congestion": 0.8,<br>  "transport_modes": ["walk", "bike"]<br>}``` |  
| **用户**           | - 总数 ≥ 10人<br>- 属性：ID、姓名、兴趣标签（如["自然", "历史"]）、历史评分 | ```json<br>{<br>  "id": "user_001",<br>  "name": "张三",<br>  "interests": ["nature", "history"],<br>  "ratings": {"diary_001": 4.5}<br>}``` |  
| **旅游日记**       | - 动态生成，无固定数量<br>- 属性：ID、标题、内容、图片/视频URL、热度（浏览量）、评分、关联景区/校园ID、用户ID | ```json<br>{<br>  "id": "diary_001",<br>  "title": "西湖一日游",<br>  "content": "文字描述...",<br>  "media_urls": ["photo1.jpg", "video1.mp4"],<br>  "popularity": 120,<br>  "rating": 4.8,<br>  "scenic_id": "scenic_001",<br>  "user_id": "user_001"<br>}``` |  

### 2.2 数据来源与验证  
- **真实数据优先**：优先使用 OpenStreetMap/高德 API 抓取道路与建筑数据，推荐通过 `osmnx` 抽取指定城市（杭州、成都、北京、西安、广州等）范围内的 POI、道路网、建筑轮廓，并补充热度、评分等属性。若抓取受限，使用附录A提供的模拟策略补齐数据缺口。  
- **动态验证**：系统运行时，数据可动态更新（如新用户注册、新日记提交）。在 SQLite 环境下由仓储层触发领域事件实现监听，部署到 PostgreSQL 时可切换为数据库触发器或 NOTIFY/LISTEN 机制。  
- **验收检查**：部署后运行 `scripts/validate_data.py`。脚本需涵盖数据量、字段完整性、交通工具标记完整性以及索引文件存在性检查。  

### 2.3 数据生成与导入流程  
1. 执行 `scripts/generate_data.py`：抓取/生成景区、校园、建筑、设施、道路、用户、日记样例等 JSON 数据；对道路边补充理想速度、拥挤度与交通工具列表。  
2. 运行 `scripts/seed_demo.py`：将生成的 JSON/CSV 数据批量导入 SQLite，同时构建 R 树索引（`indexes/spatial.idx`）与倒排索引（`indexes/fulltext.idx`）。  
3. 上线前执行 `scripts/validate_data.py`：确保景区≥200、每个景区建筑≥20、设施≥50、道路边≥200、用户≥10，并校验索引文件与媒体目录。  
4. 系统运行期间，由 APScheduler 定时任务更新景区热度、道路拥挤度，新日志提交时同步刷新倒排索引与部分排序缓存。  

---

## 3. 功能需求  
所有功能需通过Web界面实现（前端：Vue；后端：Python Fast API）。核心算法必须满足效率要求（见第4节）。  

### 3.1 旅游推荐  
**功能描述**：用户选择旅游目的地前，系统推荐前10个景点/学校，支持查询与排序。推荐结果需实时响应数据变更并考虑用户兴趣。  

#### 输入  
- 用户兴趣标签（可选，如["自然", "美食"]）  
- 排序条件（热度、评价、混合加权或个性化）  
- 查询参数（名称、类别、关键字，支持模糊匹配）  
- 数据刷新事件（新增景区/评分变化/热度更新）  

#### 处理逻辑  
1. **全局推荐生成**：  
  - 默认按 `score = 0.6 * popularity + 0.4 * rating` 计算综合得分；当用户提供兴趣标签时，引入兴趣权重系数 `interest_boost`。  
  - **核心算法**：实现**部分排序算法**（如 `Introselect` 或堆选择），仅输出前10个候选，复杂度要求 ≤ O(n)。  
  - 支持缓存机制：使用最小堆维护 TOP10，数据更新时增量调整。  
2. **查询处理**：  
  - **查找算法**：采用哈希索引 + 前缀树/倒排索引实现名称、类别、关键字搜索，平均复杂度 O(1)~O(log n)。  
  - 对查询结果再次应用部分排序，输出前10项。  
  - 支持模糊匹配与兴趣过滤（只返回与用户兴趣标签至少匹配一个的项目）。  
3. **动态更新**：  
  - 热度根据浏览量定时刷新，服务层需在刷新后通知推荐模块重建缓存。  
  - 评分发生变化时，实时更新用户-景区评分矩阵，并触发局部排序。  

#### 输出  
- 推荐/查询列表：名称、类型、热度、评价、兴趣匹配标签、距离用户所在城市（可选字段）。  
- 元数据：排序依据说明、更新时间戳、数据来源标签（真实/模拟）。  
- UI 组件：下拉筛选器（按类型/热度/评价）、兴趣标签选择器、搜索框、分页控件（仅展示前10项）。  

#### 特殊约束  
- 当数据新增/修改时，推荐列表需 ≤10 秒内刷新。  
- 热度值每日更新（基于当日浏览量），并带有时间衰减系数。  
- 推荐接口需在 1 秒内返回结果（10 并发下）。  

#### 当前实现进度（迭代 3 更新）  
- 已实现服务层 `app/services/recommendation.py`，结合部分排序与倒排索引提供地区推荐，支持混合/热度/评分三种排序策略，并为兴趣标签提供 5 分权重加成。  
- 新增 `GET /api/v1/recommendations/regions` 接口，支持 `limit`、`sort_by`、`interests`、`interests_only`、`q`、`region_type` 等查询参数，返回包含得分、基础分、兴趣匹配列表与元数据的响应。  
- 引入 `RegionRepository` 封装数据库访问逻辑，并通过 `app/api/deps.py` 暴露依赖注入。  
- 对应单元测试覆盖服务与 API：`tests/services/test_recommendation.py`、`tests/api/test_recommendations.py`。  

### 3.2 旅游路线规划  
**功能描述**：用户进入景区/校园后，规划单点或途经多点的最优路径，支持多种策略。  
#### 输入  
- 起点：用户当前位置（坐标或建筑物ID）  
- 终点：单个目标ID 或 多个目标ID列表  
- 策略选择：最短距离、最短时间（步行/自行车/电瓶车）  

#### 处理逻辑  
1. **单点路径规划**：  
   - **核心算法**：使用**Dijkstra算法**（带权图，权重=实际时间或距离）。  
     - 实际时间计算：`time = distance / (ideal_speed * congestion)`  
     - 交通工具过滤：  
       - 校园：仅允许`walk`或`bike`（自行车道需在道路数据中标记）。  
       - 景区：仅允许`walk`或`electric_cart`（电瓶车路线固定，需在道路数据中标记）。  
2. **多点路径规划**（途经所有目标点并返回起点）：  
   - **核心算法**：使用**启发式TSP变体**（如`Christofides算法`或`2-opt`），优化总时间/距离。  
     - 交通工具动态切换：路径中可混合交通工具（如步行→电瓶车→步行），需计算全局最短时间。  
3. **策略处理**：  
   - 最短距离：权重 = `distance`  
   - 最短时间：权重 = `实际时间`（考虑拥挤度）  
   - 交通工具策略：过滤不符合交通工具的道路边。  

#### 输出  
- 地图可视化：高亮显示规划路径（使用Leaflet/Mapbox）。  
- 路径详情：总距离、预估时间、交通工具切换点、关键节点列表。  
- UI组件：地图控件（缩放/拖拽）、策略选择器、目标点输入框（支持多选）。  

#### 特殊约束  
- 道路拥挤度每日更新（模拟逻辑：高峰时段拥挤度=0.3，其他时段=0.8）。  

#### 当前实现进度（迭代 3 更新）  
- 新增 `app/repositories/graph.py` 提供道路节点、边缘查询能力，并在 `app/api/deps.py` 中注入 `RoutingService` 依赖。  
- `app/services/routing.py` 封装单点最短路规划，支持时间/距离策略与交通工具过滤，异常统一抛出 `RegionNotFoundError`、`NodeValidationError`、`RouteNotFoundError`。  
- 路由接口 `GET /api/v1/routing/routes` 已上线，返回包含节点序列、路段明细、允许交通方式与总距离/时间的响应。  
- 单元测试覆盖服务与 API：`tests/services/test_routing_service.py` 验证交通模式过滤、异常分支，`tests/api/test_routing.py` 校验 HTTP 行为与依赖注入。  
- 运行 `uv run pytest` 全量通过（48 项测试），保障推荐与路由模块协同稳定。  

### 3.3 场所查询  
**功能描述**：在景区/校园内，查询附近服务设施（如洗手间、餐厅），支持距离排序与过滤。  
#### 输入  
- 参考点：当前坐标或建筑物ID  
- 查询范围：半径（默认500米，可调）  
- 过滤条件：设施类别（如仅查询"restroom"）  

#### 处理逻辑  
- **核心算法**：  
  1. **查找**：使用**空间索引**（如R-tree或Geohash）筛选范围内的设施。  
  2. **排序**：基于**实际路径距离**（非直线距离）排序：  
     - 调用3.2节的Dijkstra算法计算参考点到每个设施的最短路径距离。  
     - 输出按距离升序排列的前10项。  
- 支持动态过滤：用户选择类别后，实时更新结果。  

#### 当前实现进度（迭代 3 更新）  
- 新增 `app/repositories/facilities.py`，支持设施与图节点的联结查询，提供按区域与类别过滤的仓储接口。  
- `app/services/facility.py` 基于 `RoutingService` 计算起点至设施的最短路径距离/时间，支持半径过滤、交通方式限制与排序策略切换。  
- 暴露 `GET /api/v1/facilities/nearby` 端点，使用 `FacilityRouteResponse` 返回设施清单、路径节点序列及统计信息。  
- 补充测试：`tests/services/test_facility_service.py` 覆盖距离排序、半径与类别过滤、异常分支；`tests/api/test_facilities.py` 验证 HTTP 参数映射与错误码。  
- 运行 `uv run pytest`（56 项）全量通过，推荐、路由与设施模块联测稳定。  

#### 输出  
- 设施列表：名称、类别、距离、方向箭头。  
- 地图标记：在参考点周围显示设施位置。  

### 3.4 旅游日记管理  
**功能描述**：用户生成、浏览、查询旅游日记，支持热度推荐与AIGC动画生成。  
#### 输入  
- 日记内容：文字、图片/视频上传、关联景区ID  
- 查询参数：景区名称、日记标题、全文关键词  
- 压缩请求：日记存储指令  

#### 处理逻辑  
1. **日记存储**：  
  - **核心算法**：使用**无损压缩**（如`zlib`或`Brotli`）压缩文本和元数据，图片/视频用标准格式（JPEG/MP4）存储。  
  - 生成媒体索引（缩略图、视频封面）并写入 `storage/` 目录，记录媒体元信息。  
2. **日记查询与浏览**：  
  - 精确查询（标题）：**哈希表查找**（O(1)）。  
  - 景区相关日记：使用倒排索引匹配景区 ID，结合部分排序输出前10篇。  
  - 全文检索：构建**倒排索引**（词干提取 + 停用词过滤），基于 TF-IDF 排序并提供关键词高亮。  
3. **热度与评分推荐**：  
  - 浏览接口每次调用将热度 +1，并记录评分，服务层重算平均评分。  
  - 使用与 3.1 相同的部分排序逻辑计算 TOP10 日记，兴趣标签参与加权。  
4. **AIGC 动画生成**：  
  - 输入：用户上传的 1-5 张景点照片 + 文字描述（如“西湖雷峰塔日落”）。  
  - 输出：10 秒 720p MP4 动画，使用 MoviePy/FFmpeg + AI 模型生成（若 API 不可用则回退到 Ken Burns 效果）。  

#### 输出  
- 日记列表：标题、热度、评分、缩略图、关联景区。  
- 详情页：内容、媒体展示、AIGC动画播放器。  
- UI组件：富文本编辑器、图片上传器、全文搜索框、热度/评分排序器。  

#### 特殊约束  
- 热度 = 浏览量（每浏览+1），评分 = 用户平均分（1-5星）。  
- 动画生成任务需异步执行，并在 1 分钟内返回生成结果或进度。  

---

## 4. 核心算法规范  
| **功能**         | **算法要求**                                                                 | **验证标准**                                  |  
|------------------|----------------------------------------------------------------------------|---------------------------------------------|  
| **部分排序**     | - 实现 `Introselect` 或基于堆的部分排序<br>- 仅输出前 k 项（k=10）<br>- 时间复杂度 ≤ O(n) | 提供 `tests/algorithms/test_partial_sort.py`，覆盖大规模与动态数据场景 |  
| **最短路径**     | - Dijkstra（优先队列优化）<br>- 支持距离/时间权重切换<br>- 遇到负权边抛出错误 | `tests/algorithms/test_shortest_path.py` 验证三种交通策略 |  
| **多点路径（TSP）** | - 最近邻生成初始解 + `2-opt` 优化<br>- 支持多交通工具约束 | `tests/algorithms/test_tsp_solver.py` 验证回路闭合与时间最优 |  
| **空间查找**     | - 自研 R 树（Guttman 分裂）<br>- 支持插入、删除、范围查询 | `tests/algorithms/test_spatial_index.py` 验证查询结果与距离排序一致 |  
| **全文检索**     | - 构建倒排索引<br>- 词干提取 + 停用词过滤<br>- TF-IDF 排序 | `tests/algorithms/test_inverted_index.py` 验证检索准确度 |  
| **无损压缩**     | - 使用 `zlib`（DEFLATE）压缩文本元数据<br>- 压缩率 ≥ 50%（对示例数据） | `tests/algorithms/test_compression.py` 比较原始体积 |  

### 4.1 当前算法实现进度（迭代 2）

- **部分排序**：`app/algorithms/partial_sort.py` 中提供 `PartialSorter`、`top_k` 与 `top_k_with_scores`，支持得分缓存与稳定排序；对应测试位于 `tests/algorithms/test_partial_sort.py`。
- **最短路径**：`app/algorithms/shortest_path.py` 实现 `shortest_path`，覆盖距离/时间权重与交通工具过滤，测试见 `tests/algorithms/test_shortest_path.py`。
- **多点路径（TSP）**：`app/algorithms/tsp.py` 提供 `compute_tour`（最近邻 + 2-opt），支持复用最短路径结果及多交通模式限制；测试见 `tests/algorithms/test_tsp_solver.py`。
- **空间索引**：`app/algorithms/spatial_index.py` 中实现 R 树（插入、删除、范围查询），测试位于 `tests/algorithms/test_spatial_index.py`。
- **全文检索**：`app/algorithms/inverted_index.py` 提供 TF-IDF 倒排索引能力，对应测试 `tests/algorithms/test_inverted_index.py`。
- **无损压缩**：`app/algorithms/compression.py` 提供基于 zlib 的文本压缩/解压工具，测试位于 `tests/algorithms/test_compression.py`，示例数据压缩率≥50%。
- **质量验证**：运行 `uv run pytest tests/algorithms` 可一次性验证全部算法模块。

---

## 5. 用户界面要求  
- **地图展示**：  
  - 使用Leaflet/Mapbox，集成道路网络与POI标记。  
  - 路径规划时，用不同颜色高亮路径（绿色=最短距离，蓝色=最短时间）。  
- **响应式设计**：适配移动端（宽度≤768px）。  
- **关键页面**：  
  - 首页：推荐列表 + 搜索栏  
  - 景区详情页：地图 + 路线规划器 + 场所查询  
  - 日记页：列表视图 + 详情页 + AIGC生成器  
- **交互规范**：  
  - 所有查询支持实时预览（输入时延迟300ms触发）。  
  - 错误提示：数据不足时显示“暂无结果”，算法超时显示“计算中...”。  

---

## 6. 非功能需求  
- **性能**：  
  - 所有算法响应时间 ≤ 1s（测试环境：4核CPU，8GB RAM）。  
  - 支持10用户并发操作（无卡顿）。  
- **数据动态性**：  
  - 热度/拥挤度每小时更新（模拟脚本：`popularity = base * (1 + sin(current_hour))`）。  
  - 新日记提交后，推荐列表10秒内刷新。  
- **可维护性**：  
  - 代码模块化（推荐、规划、查询、日记各为独立模块）。  
  - 关键算法提供单元测试（覆盖率 ≥ 80%）。  

---

## 7. 验收标准  
AI交付系统必须通过以下检查：  
1. **数据验证**：  
   - 运行`validate_data.py`（附录B），确认：  
     - `scenic_count ≥ 200`  
     - `building_count ≥ 20 per scenic`  
     - `edge_count ≥ 200`  
     - `user_count ≥ 10`  
2. **功能测试**：  
   - 旅游推荐：输入兴趣标签，输出前10项正确排序。  
   - 路线规划：输入多点目标，输出路径符合最短时间策略。  
   - 日记查询：全文检索返回相关结果，压缩率 ≥ 50%。  
3. **性能测试**：  
   - 使用`load_test.py`（附录B）模拟10用户，95%请求延迟 < 1s。  
4. **交付物**：  
   - 完整源代码（含算法实现）  
   - 数据集文件（JSON/CSV）  
   - 测试报告（含性能数据）  

---

## 8. 开发迭代计划  
| 迭代 | 目标 | 核心交付 | 验证点 |  
|------|------|----------|--------|  
| Iteration 0 | 需求梳理与架构确认 | 更新《项目文档》、生成系统架构图与目录规划 | 文档评审通过 |  
| Iteration 1 | 后端骨架与数据初始化 | FastAPI 项目结构、基础路由、数据库模型、数据生成脚本 | `scripts/validate_data.py` 通过 |  
| Iteration 2 | 核心算法模块 | 部分排序、Dijkstra、TSP、R 树、倒排索引、压缩，与配套单元测试 | `pytest tests/algorithms` 全绿 |  
| Iteration 3 | 业务服务与 API | 推荐、路线、场所查询、日记、AIGC 接口、后台任务 | 自动化接口测试通过 |  
| Iteration 4 | 前端应用 | Vue 页面、地图交互、富文本编辑、动画上传/播放 | `npm run test` & Cypress 冒烟 |  
| Iteration 5 | 联调与性能 | 前后端联调、负载测试、数据验证、Bug 修复 | `load_test.py`、端到端脚本通过 |  
| Iteration 6 | 交付与部署 | README、部署文档、测试报告、打包脚本 | 验收会议通过 |  

### 8.1 风险与缓解措施  
- **真实数据获取受限**：提前缓存 OSM PBF 文件，准备多城市候选；若外部 API 限流，使用离线数据解析。  
- **算法性能不达标**：建立性能基线，必要时使用 NumPy/Cython 加速或采用近似算法优化。  
- **多交通工具建模复杂**：在道路数据中明确 `transport_modes` 列表，服务层在调用算法前过滤非法边。  

### 8.2 质量保障策略  
- 单元测试覆盖率保持 ≥80%，CI 中设置覆盖率阈值。  
- 引入 `ruff`、`mypy`、ESLint/Prettier 等静态检查，保障代码质量与类型安全。  
- 针对关键算法提供基准测试脚本，持续跟踪响应时间。  
- 部署前执行数据验证脚本、负载测试与端到端回归测试，生成正式报告归档。  

---

## 附录A：模拟数据生成逻辑  
若真实数据不足，AI必须按此逻辑生成模拟数据：  
- **景区/校园**：  
  - 名称：`[城市名] + [类型]`（如"杭州西湖景区"）  
  - 热度：`randint(30, 100)`  
  - 评价：`round(uniform(2.0, 5.0), 1)`  
- **道路网络**：  
  - 边数：确保 ≥ 200，使用Prim算法生成连通图。  
  - 拥挤度：`0.8 - 0.5 * sin(2π * current_hour / 24)`（模拟高峰波动）  
- **服务设施**：  
  - 类别分布：洗手间(20%)、餐厅(25%)、商店(15%)...（覆盖10类）  
  - 坐标：在建筑物附件1000米以内的道路边随机生成。  

## 附录B：验证脚本示例  
```python  
# validate_data.py  
import json  

def check_data():  
    with open("scenics.json") as f:  
        scenics = json.load(f)  
        assert len(scenics) >= 200, "景区数量不足200"  

    with open("edges.json") as f:  
        edges = json.load(f)  
        assert len(edges) >= 200, "道路边数不足200"  

    # 检查每个景区建筑物 ≥20  
    building_count = {}  
    for b in json.load(open("buildings.json")):  
        building_count[b["parent_id"]] = building_count.get(b["parent_id"], 0) + 1  
    assert all(count >= 20 for count in building_count.values()), "建筑物数量不足"  

    print("数据验证通过！")  

if __name__ == "__main__":  
    check_data()  
```  

---  
**AI开发指令**：  
1. 严格按本文档实现系统，**禁止省略任何硬性要求**（如数据规模、算法类型）。  
2. 优先使用高效算法（部分排序、空间索引等），避免全量计算。  
3. 交付时提供完整测试报告，证明所有验收标准达标。  
4. 若需求存在模糊点，**默认采用最严格解释**（例如：部分排序必须仅输出前10项）。  